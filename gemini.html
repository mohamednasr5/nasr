<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مستقبل الذكاء الاصطناعي - مولد المشاهد الاحترافي</title>
<!-- خط تجوال للعربية و Inter للإنجليزية والأرقام -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-hue: 220;
  --primary: hsl(var(--primary-hue), 90%, 60%);
  --primary-dark: hsl(var(--primary-hue), 90%, 50%);
  --primary-light: hsl(var(--primary-hue), 90%, 95%);
  
  --bg-dark: #0f172a;
  --bg-panel: #1e293b;
  --bg-input: #334155;
  
  --text-main: #f1f5f9;
  --text-muted: #94a3b8;
  
  --accent-green: #10b981;
  --accent-red: #ef4444;
  --accent-gold: #f59e0b;
  
  --border: rgba(255, 255, 255, 0.08);
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
  --font-ar: 'Tajawal', sans-serif;
  --font-en: 'Inter', sans-serif;
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  font-family: var(--font-ar);
  background-color: var(--bg-dark);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background-image: 
    radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
    radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 40%);
}

/* --- Header --- */
header {
  height: 70px;
  background: rgba(15, 23, 42, 0.8);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 2rem;
  position: sticky;
  top: 0;
  z-index: 50;
}

.logo {
  font-weight: 800;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.header-controls button {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-muted);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: 0.3s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.header-controls button:hover {
  color: var(--text-main);
  background: var(--primary);
  border-color: var(--primary);
}

/* --- Main Layout --- */
.layout-container {
  display: grid;
  grid-template-columns: 400px 1fr;
  gap: 2rem;
  max-width: 1600px;
  margin: 0 auto;
  padding: 2rem;
  width: 100%;
  flex: 1;
}

/* --- Sidebar (Controls) --- */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.section-card {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
  box-shadow: var(--shadow);
  transition: transform 0.2s ease;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
  font-weight: 700;
  color: var(--primary);
  font-size: 1.1rem;
}

.form-control {
  margin-bottom: 1.25rem;
  position: relative;
}

.form-control label {
  display: block;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-muted);
  font-weight: 500;
}

textarea, input[type="text"], select {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid transparent;
  color: var(--text-main);
  padding: 0.85rem;
  border-radius: var(--radius-sm);
  font-family: var(--font-ar);
  font-size: 0.95rem;
  transition: 0.3s;
  resize: vertical;
}

textarea:focus, input:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

/* Custom Inputs */
.input-row {
  display: flex;
  gap: 1rem;
}

.toggle-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 0.5rem 0;
}

.toggle-switch input { display: none; }

.toggle-track {
  width: 44px;
  height: 24px;
  background: var(--bg-input);
  border-radius: 20px;
  position: relative;
  transition: 0.3s;
}

.toggle-track::after {
  content: '';
  position: absolute;
  top: 2px;
  right: 2px; /* RTL logic */
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}

.toggle-switch input:checked + .toggle-track {
  background: var(--primary);
}

.toggle-switch input:checked + .toggle-track::after {
  transform: translateX(-20px);
}

/* Scene Selector Grid */
.scenes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 0.75rem;
  max-height: 300px;
  overflow-y: auto;
  padding: 0.25rem;
}

.scene-chip {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 0.75rem 0.5rem;
  text-align: center;
  cursor: pointer;
  font-size: 0.85rem;
  transition: 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  user-select: none;
}

.scene-chip i { font-size: 1.2rem; color: var(--text-muted); }
.scene-chip:hover { background: rgba(255,255,255,0.05); }
.scene-chip.selected {
  border-color: var(--primary);
  background: rgba(59, 130, 246, 0.1);
  color: var(--primary);
}
.scene-chip.selected i { color: var(--primary); }

/* --- Main Content (Preview) --- */
.main-content {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.output-container {
  background: #000;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 600px;
  position: relative;
  overflow: hidden;
}

.code-header {
  background: #1e1e1e;
  padding: 0.75rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #333;
}

.code-lang {
  font-family: var(--font-en);
  font-size: 0.8rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.code-actions button {
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  font-size: 0.9rem;
  transition: 0.2s;
}

.code-actions button:hover { color: var(--text-main); }

#promptOutput {
  flex: 1;
  background: #0d0d0d;
  color: #d4d4d4;
  padding: 1.5rem;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 0.95rem;
  line-height: 1.7;
  border: none;
  resize: none;
  direction: ltr; /* Code is always LTR mostly */
}

/* Utility Buttons */
.btn {
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: var(--radius-sm);
  font-family: var(--font-ar);
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: 0.2s;
  font-size: 0.95rem;
}

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}
.btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }

.btn-secondary {
  background: var(--bg-input);
  color: var(--text-main);
}
.btn-secondary:hover { background: #475569; }

.btn-success { background: var(--accent-green); color: white; }
.btn-danger { background: var(--accent-red); color: white; }

.action-bar {
  display: flex;
  gap: 1rem;
  margin-top: auto;
}

/* Stats Bar */
.stats-bar {
  display: flex;
  gap: 2rem;
  padding: 1rem 0;
  border-bottom: 1px solid var(--border);
  margin-bottom: 1rem;
}

.stat-item {
  text-align: center;
}
.stat-val { display: block; font-size: 1.25rem; font-weight: 700; color: var(--text-main); font-family: var(--font-en); }
.stat-label { font-size: 0.8rem; color: var(--text-muted); }

/* Toast */
.toast-container {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%);
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toast {
  background: var(--bg-panel);
  color: var(--text-main);
  padding: 1rem 2rem;
  border-radius: 50px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  border: 1px solid var(--primary);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  animation: slideUp 0.3s ease-out;
  min-width: 300px;
  justify-content: center;
}

.toast.success i { color: var(--accent-green); }
.toast.error i { color: var(--accent-red); }

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Mobile Responsive */
@media (max-width: 1024px) {
  .layout-container { grid-template-columns: 1fr; }
  .sidebar { order: 2; }
  .main-content { order: 1; }
  .output-container { min-height: 400px; }
}

@media (max-width: 600px) {
  header { padding: 0 1rem; }
  .layout-container { padding: 1rem; }
  .input-row { flex-direction: column; gap: 0.75rem; }
  .action-bar { flex-direction: column; }
  .btn { width: 100%; justify-content: center; }
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <i class="fas fa-cube"></i> AI PROMPTER
  </div>
  <div class="header-controls">
    <button id="resetBtn" title="إعادة ضبط"><i class="fas fa-rotate-right"></i></button>
    <button id="themeBtn" title="المظهر (الوضع الداكن فقط حالياً)"><i class="fas fa-moon"></i></button>
  </div>
</header>

<div class="layout-container">
  <!-- Sidebar: Controls -->
  <aside class="sidebar">
    
    <!-- Concept Section -->
    <section class="section-card">
      <div class="section-header">
        <span><i class="fas fa-brain"></i> المفهوم العام</span>
      </div>
      
      <div class="form-control">
        <label>وصف الجلسة (Idea)</label>
        <textarea id="ideaInput" rows="3" placeholder="مثال: جلسة تصوير لرجل أعمال في مكتب عصري بتصوير سينمائي..."></textarea>
      </div>

      <div class="form-control">
        <label>النموذج السلبي (Negative Prompt)</label>
        <input type="text" id="negativeInput" placeholder="مثال: blurry, deformed hands, bad anatomy..." />
        <small style="color:var(--text-muted); font-size:0.75rem;">الأشياء التي يجب تجنبها في الصورة</small>
      </div>
    </section>

    <!-- Scenes Section -->
    <section class="section-card">
      <div class="section-header">
        <span><i class="fas fa-layer-group"></i> المشاهد</span>
        <span id="sceneCountBadge" style="font-size:0.8rem; background:var(--bg-input); padding:2px 8px; border-radius:10px;">0 محدد</span>
      </div>

      <div class="form-control">
        <label>إضافة المشاهد يدوياً</label>
        <div style="display:flex; gap:0.5rem;">
          <input type="text" id="manualSceneInput" placeholder="اكتب وصف المشهد واضغط إضافة" />
          <button class="btn btn-secondary" id="addSceneBtn" style="padding: 0 1rem;"><i class="fas fa-plus"></i></button>
        </div>
      </div>

      <div class="form-control">
        <label>أو اختر من القوالب الجاهزة</label>
        <div class="scenes-grid" id="predefinedScenesGrid">
          <!-- Generated by JS -->
        </div>
      </div>
      
      <div id="selectedScenesContainer" style="display:none; margin-top:1rem;">
        <label style="color:var(--primary); font-size:0.85rem; margin-bottom:0.5rem; display:block;">المشاهد المختارة (للحذف اضغط ×):</label>
        <div id="selectedScenesList" style="display:flex; flex-wrap:wrap; gap:0.5rem;"></div>
      </div>
    </section>

    <!-- Technical Section -->
    <section class="section-card">
      <div class="section-header">
        <span><i class="fas fa-sliders-h"></i> الإعدادات التقنية</span>
      </div>

      <div class="input-row form-control">
        <div style="flex:1">
          <label>الأبعاد (Aspect Ratio)</label>
          <select id="aspectRatio">
            <option value="--ar 16:9">16:9 (عريض)</option>
            <option value="--ar 9:16">9:16 (عمودي/موبايل)</option>
            <option value="--ar 1:1" selected>1:1 (مربع)</option>
            <option value="--ar 4:3">4:3 (كلاسيكي)</option>
            <option value="--ar 21:9">21:9 (سينمائي)</option>
          </select>
        </div>
        <div style="flex:1">
          <label>الجودة (Stylize)</label>
          <select id="stylize">
            <option value="--s 100">100 (افتراضي)</option>
            <option value="--s 250">250 (إبداعي)</option>
            <option value="--s 750">750 (أقصى إبداع)</option>
          </select>
        </div>
      </div>

      <label class="toggle-switch">
        <span>تنوع المشاهد (Diversity)</span>
        <input type="checkbox" id="diversityToggle" checked>
        <div class="toggle-track"></div>
      </label>
      
      <label class="toggle-switch" style="margin-top:1rem;">
        <span>تضمين التوقيع (Signature)</span>
        <input type="checkbox" id="signatureToggle" checked>
        <div class="toggle-track"></div>
      </label>

      <!-- حقل إدخال التوقيع الجديد -->
      <div id="signatureInputContainer" class="form-control" style="margin-top: 0.5rem; display: block;">
        <label>نص التوقيع (Signature Text)</label>
        <input type="text" id="signatureText" placeholder="Eng / Mohamed / Hammad" value="Eng / Mohamed / Hammad" />
      </div>

      <label class="toggle-switch" style="margin-top:1rem;">
        <span>الناتج بصيغة JSON (للمطورين)</span>
        <input type="checkbox" id="jsonModeToggle">
        <div class="toggle-track"></div>
      </label>
    </section>

  </aside>

  <!-- Main: Output -->
  <main class="main-content">
    
    <div class="section-card" style="height:100%; display:flex; flex-direction:column; padding:0;">
      <div class="stats-bar" style="margin: 1.5rem 1.5rem 0;">
        <div class="stat-item">
          <span class="stat-val" id="totalWords">0</span>
          <span class="stat-label">كلمة</span>
        </div>
        <div class="stat-item">
          <span class="stat-val" id="totalTokens">~0</span>
          <span class="stat-label">Token</span>
        </div>
        <div class="stat-item" style="flex:1; text-align:left;">
          <span class="stat-label" id="statusIndicator">جاهز للإنشاء</span>
        </div>
      </div>

      <div class="output-container" style="border:none; margin:1rem;">
        <div class="code-header">
          <span class="code-lang" id="codeLang">PROMPT / TEXT</span>
          <div class="code-actions">
            <button id="clearBtn"><i class="fas fa-trash"></i> مسح</button>
            <button id="copyBtn"><i class="fas fa-copy"></i> نسخ</button>
          </div>
        </div>
        <textarea id="promptOutput" readonly spellcheck="false" placeholder="سيظهر الناتج هنا..."></textarea>
      </div>

      <div class="action-bar" style="padding: 1.5rem;">
        <button id="generateBtn" class="btn btn-primary" style="flex:2; justify-content:center; padding: 1rem;">
          <i class="fas fa-wand-magic-sparkles"></i> إنشاء الطلب (Generate)
        </button>
        <button id="downloadBtn" class="btn btn-secondary" style="flex:1;">
          <i class="fas fa-download"></i> تحميل
        </button>
      </div>
    </div>

  </main>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
/**
 * Application Logic
 * Implements MVC-like structure for clarity
 */

const PREDEFINED_SCENES = [
  { id: 'p1', icon: 'fa-user-tie', label: 'بورتريه أعمال', desc: 'Professional portrait, business attire, office background, confident expression' },
  { id: 'p2', icon: 'fa-camera-retro', label: 'سينمائي', desc: 'Cinematic shot, dramatic lighting, moody atmosphere, film grain' },
  { id: 'p3', icon: 'fa-sun', label: 'طبيعي', desc: 'Natural light, outdoor, sunny day, soft shadows, vibrant colors' },
  { id: 'p4', icon: 'fa-city', label: 'عمراني', desc: 'Urban setting, city street, night lights, cyberpunk vibes' },
  { id: 'p5', icon: 'fa-leaf', label: 'طبيعة', desc: 'Nature background, forest, greenery, peaceful, macro details' },
  { id: 'p6', icon: 'fa-tshirt', label: 'أزياء', desc: 'Fashion editorial, full body, dynamic pose, studio lighting' },
  { id: 'p7', icon: 'fa-laptop', label: 'تقنية', desc: 'Tech setup, workspace, multiple monitors, clean minimal desk, blue lighting' },
  { id: 'p8', icon: 'fa-coffee', label: 'كاجوال', desc: 'Casual lifestyle, coffee shop, relaxed, candid moment, warm tones' }
];

class PromptApp {
  constructor() {
    this.state = {
      idea: '',
      negative: '',
      scenes: [], // Array of strings
      signatureText: 'Eng / Mohamed / Hammad', // New State
      settings: {
        aspectRatio: '--ar 1:1',
        stylize: '--s 100',
        diversity: true,
        signature: true,
        jsonMode: false
      }
    };

    this.init();
  }

  init() {
    this.cacheDOM();
    this.bindEvents();
    this.renderPredefinedScenes();
    this.loadFromStorage();
  }

  cacheDOM() {
    this.dom = {
      idea: document.getElementById('ideaInput'),
      negative: document.getElementById('negativeInput'),
      manualScene: document.getElementById('manualSceneInput'),
      addSceneBtn: document.getElementById('addSceneBtn'),
      predefinedGrid: document.getElementById('predefinedScenesGrid'),
      selectedList: document.getElementById('selectedScenesList'),
      selectedContainer: document.getElementById('selectedScenesContainer'),
      sceneCountBadge: document.getElementById('sceneCountBadge'),
      
      aspectRatio: document.getElementById('aspectRatio'),
      stylize: document.getElementById('stylize'),
      diversity: document.getElementById('diversityToggle'),
      signature: document.getElementById('signatureToggle'),
      signatureText: document.getElementById('signatureText'), // New Input
      signatureInputContainer: document.getElementById('signatureInputContainer'), // Container
      jsonMode: document.getElementById('jsonModeToggle'),
      
      output: document.getElementById('promptOutput'),
      codeLang: document.getElementById('codeLang'),
      
      generateBtn: document.getElementById('generateBtn'),
      copyBtn: document.getElementById('copyBtn'),
      clearBtn: document.getElementById('clearBtn'),
      downloadBtn: document.getElementById('downloadBtn'),
      resetBtn: document.getElementById('resetBtn'),
      
      totalWords: document.getElementById('totalWords'),
      totalTokens: document.getElementById('totalTokens'),
      status: document.getElementById('statusIndicator'),
      toastContainer: document.getElementById('toastContainer')
    };
  }

  bindEvents() {
    // Input Changes
    this.dom.idea.addEventListener('input', (e) => this.updateState('idea', e.target.value));
    this.dom.negative.addEventListener('input', (e) => this.updateState('negative', e.target.value));
    
    // Settings
    this.dom.aspectRatio.addEventListener('change', (e) => this.updateSetting('aspectRatio', e.target.value));
    this.dom.stylize.addEventListener('change', (e) => this.updateSetting('stylize', e.target.value));
    this.dom.diversity.addEventListener('change', (e) => this.updateSetting('diversity', e.target.checked));
    
    // Signature Logic (Updated)
    this.dom.signature.addEventListener('change', (e) => {
      this.updateSetting('signature', e.target.checked);
      // Toggle input visibility
      this.dom.signatureInputContainer.style.display = e.target.checked ? 'block' : 'none';
    });
    
    // Signature Text Input
    this.dom.signatureText.addEventListener('input', (e) => this.updateState('signatureText', e.target.value));

    this.dom.jsonMode.addEventListener('change', (e) => {
      this.updateSetting('jsonMode', e.target.checked);
      this.dom.codeLang.textContent = e.target.checked ? 'JSON / DATA' : 'PROMPT / TEXT';
    });

    // Add Manual Scene
    this.dom.addSceneBtn.addEventListener('click', () => this.addManualScene());
    this.dom.manualScene.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.addManualScene();
    });

    // Actions
    this.dom.generateBtn.addEventListener('click', () => this.generate());
    this.dom.copyBtn.addEventListener('click', () => this.copyToClipboard());
    this.dom.clearBtn.addEventListener('click', () => this.clearOutput());
    this.dom.downloadBtn.addEventListener('click', () => this.download());
    this.dom.resetBtn.addEventListener('click', () => {
      if(confirm('هل أنت متأكد من مسح جميع البيانات؟')) this.resetAll();
    });
  }

  updateState(key, value) {
    this.state[key] = value;
    this.saveToStorage();
  }

  updateSetting(key, value) {
    this.state.settings[key] = value;
    this.saveToStorage();
  }

  /* --- Scene Management --- */

  renderPredefinedScenes() {
    this.dom.predefinedGrid.innerHTML = PREDEFINED_SCENES.map(scene => `
      <div class="scene-chip" id="chip-${scene.id}" onclick="app.togglePredefined('${scene.id}')">
        <i class="fas ${scene.icon}"></i>
        <span>${scene.label}</span>
      </div>
    `).join('');
  }

  togglePredefined(id) {
    const sceneObj = PREDEFINED_SCENES.find(s => s.id === id);
    const chip = document.getElementById(`chip-${id}`);
    
    // Check if already added
    const existingIndex = this.state.scenes.findIndex(s => s === sceneObj.desc);
    
    if (existingIndex > -1) {
      this.state.scenes.splice(existingIndex, 1);
      chip.classList.remove('selected');
    } else {
      this.state.scenes.push(sceneObj.desc);
      chip.classList.add('selected');
    }
    
    this.renderSelectedScenes();
    this.saveToStorage();
  }

  addManualScene() {
    const val = this.dom.manualScene.value.trim();
    if (!val) return;

    this.state.scenes.push(val);
    this.dom.manualScene.value = '';
    this.renderSelectedScenes();
    this.saveToStorage();
    this.showToast('تمت إضافة المشهد', 'success');
  }

  removeScene(index) {
    this.state.scenes.splice(index, 1);
    
    // Deselect predefined if it matches
    const desc = this.state.scenes[index]; 
    PREDEFINED_SCENES.forEach(s => {
      const chip = document.getElementById(`chip-${s.id}`);
      if (!this.state.scenes.includes(s.desc)) {
        chip.classList.remove('selected');
      }
    });

    this.renderSelectedScenes();
    this.saveToStorage();
  }

  renderSelectedScenes() {
    const list = this.dom.selectedList;
    const container = this.dom.selectedContainer;
    const badge = this.dom.sceneCountBadge;

    badge.textContent = `${this.state.scenes.length} محدد`;

    if (this.state.scenes.length === 0) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    list.innerHTML = this.state.scenes.map((scene, index) => `
      <div style="background:var(--bg-input); padding:0.5rem 0.75rem; border-radius:6px; font-size:0.8rem; display:flex; align-items:center; gap:0.5rem; border:1px solid var(--border);">
        <span style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${scene}</span>
        <i class="fas fa-times" style="cursor:pointer; color:var(--accent-red);" onclick="app.removeScene(${index})"></i>
      </div>
    `).join('');
  }

  /* --- Generation Logic --- */

  generate() {
    if (!this.state.idea && this.state.scenes.length === 0) {
      this.showToast('يرجى إدخال فكرة أو إضافة مشاهد واحدة على الأقل', 'error');
      return;
    }

    this.dom.status.textContent = 'جاري الإنشاء...';
    this.dom.generateBtn.disabled = true;

    setTimeout(() => {
      const result = this.state.settings.jsonMode ? this.generateJSON() : this.generateText();
      this.dom.output.value = result;
      
      // Stats Update
      const wordCount = result.split(/\s+/).length;
      this.dom.totalWords.textContent = wordCount;
      this.dom.totalTokens.textContent = `~${Math.ceil(wordCount * 1.3)}`;
      
      this.dom.status.textContent = 'تم الإنشاء بنجاح';
      this.dom.generateBtn.disabled = false;
      this.showToast('تم إنشاء الطلب بنجاح!', 'success');
      
      // Auto copy
      this.copyToClipboard();
    }, 300); // Simulate processing
  }

  generateText() {
    const { idea, negative, scenes, settings, signatureText } = this.state;
    
    let promptParts = [];

    // 1. Header
    promptParts.push(`**IMAGINE PROJECT PROMPT**`);
    promptParts.push(`---`);
    
    // 2. Concept
    if (idea) {
      promptParts.push(`[CONCEPT]: ${idea}`);
    }

    // 3. Technical Params
    promptParts.push(`[PARAMS]: ${settings.aspectRatio} ${settings.stylize} --v 6.0`);
    if (negative) promptParts.push(`[NEGATIVE]: ${negative}`);

    // 4. Diversity
    if (settings.diversity) {
      promptParts.push(`[DIVERSITY INSTRUCTION]: Strict visual diversity required. Each generated image must vary significantly in pose, angle, lighting, and background from the others.`);
    }

    // 5. Scenes
    if (scenes.length > 0) {
      promptParts.push(`\n[SCENES BREAKDOWN]:`);
      scenes.forEach((scene, i) => {
        promptParts.push(`${i + 1}. ${scene}`);
      });
    } else {
      promptParts.push(`\n[SCENES BREAKDOWN]: Generate variations based on the Concept provided.`);
    }

    // 6. Signature (Updated to use input value)
    if (settings.signature) {
      promptParts.push(`\n[SIGNATURE REQUIREMENT]: Elegant watermark in bottom right "${signatureText}" - minimal size, readable.`);
    }

    promptParts.push(`---\nEND OF PROMPT`);
    
    return promptParts.join('\n');
  }

  generateJSON() {
    const { idea, negative, scenes, settings, signatureText } = this.state;
    
    const sceneObjects = scenes.length > 0 ? scenes.map((desc, i) => ({
      id: i + 1,
      prompt: desc,
      weight: 1
    })) : [{
      id: 1,
      prompt: idea || "Creative photography based on concept",
      weight: 1
    }];

    const data = {
      project: {
        concept: idea,
        negative_prompt: negative,
        technical: {
          aspect_ratio: settings.aspectRatio,
          stylize: settings.stylize,
          version: 6.0
        },
        enforce_diversity: settings.diversity,
        signature: settings.signature ? signatureText : null // Updated
      },
      scenes: sceneObjects
    };

    return JSON.stringify(data, null, 2);
  }

  /* --- Utilities --- */

  clearOutput() {
    this.dom.output.value = '';
    this.dom.totalWords.textContent = '0';
    this.dom.totalTokens.textContent = '0';
    this.dom.status.textContent = 'تم المسح';
  }

  async copyToClipboard() {
    if (!this.dom.output.value) return;
    try {
      await navigator.clipboard.writeText(this.dom.output.value);
      this.showToast('تم النسخ للحافظة!', 'success');
      const icon = this.dom.copyBtn.querySelector('i');
      icon.className = 'fas fa-check';
      setTimeout(() => icon.className = 'fas fa-copy', 2000);
    } catch (err) {
      this.showToast('فشل النسخ', 'error');
    }
  }

  download() {
    if (!this.dom.output.value) {
      this.showToast('لا يوجد محتوى للتحميل', 'error');
      return;
    }
    const blob = new Blob([this.dom.output.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prompt-${Date.now()}.${this.state.settings.jsonMode ? 'json' : 'txt'}`;
    a.click();
    URL.revokeObjectURL(url);
  }

  showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = type === 'success' 
      ? `<i class="fas fa-check-circle"></i> ${msg}`
      : `<i class="fas fa-exclamation-circle"></i> ${msg}`;
    
    this.dom.toastContainer.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  saveToStorage() {
    localStorage.setItem('aiPrompterState', JSON.stringify(this.state));
  }

  loadFromStorage() {
    const saved = localStorage.getItem('aiPrompterState');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        this.state = { ...this.state, ...parsed };
        
        // Populate UI
        this.dom.idea.value = this.state.idea || '';
        this.dom.negative.value = this.state.negative || '';
        this.dom.aspectRatio.value = this.state.settings.aspectRatio;
        this.dom.stylize.value = this.state.settings.stylize;
        this.dom.diversity.checked = this.state.settings.diversity;
        this.dom.signature.checked = this.state.settings.signature;
        this.dom.signatureText.value = this.state.signatureText || '';
        this.dom.jsonMode.checked = this.state.settings.jsonMode;
        
        // Handle Signature Input Visibility based on saved state
        this.dom.signatureInputContainer.style.display = this.state.settings.signature ? 'block' : 'none';
        
        this.renderSelectedScenes();
        
        // Re-select predefined UI
        PREDEFINED_SCENES.forEach(s => {
          if (this.state.scenes.includes(s.desc)) {
            const chip = document.getElementById(`chip-${s.id}`);
            if (chip) chip.classList.add('selected');
          }
        });

      } catch (e) {
        console.error('Error loading state', e);
      }
    }
  }

  resetAll() {
    localStorage.removeItem('aiPrompterState');
    location.reload();
  }
}

// Initialize App
const app = new PromptApp();

</script>
</body>
</html>
